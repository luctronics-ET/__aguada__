<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitoramento de Abastecimento - AGUADA</title>
    <link rel="stylesheet" href="assets/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      .supply-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .supply-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .supply-card h3 {
        color: var(--primary-blue);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .supply-status {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        background: var(--background-light);
        border-radius: 6px;
        margin-bottom: 15px;
      }

      .supply-indicator {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }

      .supply-indicator.active {
        background: var(--success-green);
        animation: pulse 2s infinite;
      }

      .supply-indicator.inactive {
        background: var(--border-color);
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .supply-info {
        flex: 1;
      }

      .supply-info .label {
        font-size: 12px;
        color: var(--text-muted);
      }

      .supply-info .value {
        font-size: 20px;
        font-weight: bold;
        color: var(--text-dark);
      }

      .event-list {
        list-style: none;
        padding: 0;
      }

      .event-item {
        padding: 12px;
        border-left: 4px solid var(--accent-purple);
        background: var(--background-light);
        margin-bottom: 10px;
        border-radius: 4px;
      }

      .event-item.supply {
        border-left-color: var(--success-green);
      }

      .event-item.consumption {
        border-left-color: var(--warning-orange);
      }

      .event-item.leak {
        border-left-color: var(--danger-red);
      }

      .event-time {
        font-size: 12px;
        color: var(--text-muted);
      }

      .event-desc {
        font-weight: 500;
        margin-top: 4px;
      }

      .progress-bar {
        height: 8px;
        background: var(--border-color);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--accent-purple),
          var(--primary-blue)
        );
        transition: width 0.5s ease;
      }
    </style>
  </head>
  <body>
    <div class="admin-header">
      <div class="admin-header-top">
        <h1>üíß Monitoramento de Abastecimento - AGUADA</h1>
        <div class="status-indicator">
          <div class="status-dot"></div>
          <span>‚óè Online</span>
        </div>
      </div>
      <nav class="admin-nav">
        <a href="index.html">Dashboard</a>
        <a href="mapa.html">Mapa</a>
        <a href="painel.html">Painel Visual</a>
        <a href="dados.html">Dados</a>
        <a href="consumo.html">Consumo</a>
        <a href="abastecimento.html" class="active">Abastecimento</a>
        <a href="manutencao.html">Manuten√ß√£o</a>
        <a href="history.html">Hist√≥rico</a>
        <a href="alerts.html">Alertas</a>
        <a href="config.html">Configura√ß√µes</a>
        <a href="system.html">Sistema</a>
        <a href="documentacao.html">Docs</a>
      </nav>
    </div>

    <div class="main-container">
      <div class="supply-grid">
        <div class="supply-card">
          <h3>üö∞ Status de Abastecimento</h3>
          <div class="supply-status">
            <div class="supply-indicator inactive" id="supplyIndicator">üíß</div>
            <div class="supply-info">
              <div class="label">Status Atual</div>
              <div class="value" id="supplyStatus">Inativo</div>
              <div class="event-time" id="supplyTime">√öltimo: --:--</div>
            </div>
          </div>

          <div style="margin-top: 20px">
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
              "
            >
              <span style="font-size: 14px; color: var(--text-muted)"
                >Volume abastecido hoje</span
              >
              <span style="font-weight: bold" id="volumeToday">0 m¬≥</span>
            </div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="volumeProgress"
                style="width: 0%"
              ></div>
            </div>
            <div
              style="font-size: 12px; color: var(--text-muted); margin-top: 4px"
            >
              Meta di√°ria: <span id="dailyTarget">50 m¬≥</span>
            </div>
          </div>
        </div>

        <div class="supply-card">
          <h3>‚è±Ô∏è Tempo de Abastecimento</h3>
          <div style="text-align: center; padding: 20px 0">
            <div
              style="
                font-size: 48px;
                font-weight: bold;
                color: var(--primary-blue);
              "
              id="supplyDuration"
            >
              00:00:00
            </div>
            <div style="color: var(--text-muted); margin-top: 8px">
              Dura√ß√£o da sess√£o atual
            </div>
          </div>

          <div style="margin-top: 20px">
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
              "
            >
              <span style="font-size: 14px">Taxa M√©dia:</span>
              <span style="font-weight: bold" id="avgRate">0 L/min</span>
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
              "
            >
              <span style="font-size: 14px">Tempo Total (Hoje):</span>
              <span style="font-weight: bold" id="totalTime">0h 0min</span>
            </div>
          </div>
        </div>

        <div class="supply-card">
          <h3>üéØ Previs√£o de Conclus√£o</h3>
          <div style="text-align: center; padding: 20px 0">
            <div
              style="
                font-size: 36px;
                font-weight: bold;
                color: var(--accent-purple);
              "
              id="estimatedTime"
            >
              --:--
            </div>
            <div style="color: var(--text-muted); margin-top: 8px">
              Hor√°rio estimado (100%)
            </div>
          </div>

          <div
            style="
              margin-top: 20px;
              background: var(--background-light);
              padding: 15px;
              border-radius: 6px;
            "
          >
            <div style="font-size: 14px; margin-bottom: 8px">
              <strong>Reservat√≥rio Alvo:</strong>
              <span id="targetReservoir">RCON</span>
            </div>
            <div style="font-size: 14px; margin-bottom: 8px">
              <strong>N√≠vel Atual:</strong> <span id="currentLevel">0%</span>
            </div>
            <div style="font-size: 14px">
              <strong>Faltam:</strong> <span id="remainingVolume">0 m¬≥</span>
            </div>
          </div>
        </div>
      </div>

      <div class="supply-card" style="margin-bottom: 20px">
        <h3>üìä Hist√≥rico de Abastecimento (√öltimos 7 dias)</h3>
        <canvas id="supplyHistoryChart"></canvas>
      </div>

      <div class="supply-card">
        <h3>üìã Eventos Recentes</h3>
        <ul class="event-list" id="eventList">
          <li style="text-align: center; color: #999; padding: 20px">
            ‚è≥ Carregando eventos...
          </li>
        </ul>
      </div>
    </div>

    <script src="assets/layout.js"></script>
    <script src="assets/api-service.js"></script>
    <script src="assets/ui-utils.js"></script>
    <script src="assets/app.js"></script>
    <script>
      let supplyChart;
      let sessionStartTime = null;
      let durationInterval = null;

      // Initialize supply history chart
      async function initSupplyChart() {
        const ctx = document
          .getElementById("supplyHistoryChart")
          .getContext("2d");
        const supplyData = await fetchSupplyData(7);
        supplyChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: supplyData.labels,
            datasets: [
              {
                label: "Volume Abastecido (m¬≥)",
                data: supplyData.volumes,
                backgroundColor: "rgba(16, 185, 129, 0.7)",
                borderColor: "rgba(16, 185, 129, 1)",
                borderWidth: 1,
              },
              {
                label: "N√∫mero de Sess√µes",
                data: supplyData.sessions,
                type: "line",
                borderColor: "rgba(103, 126, 234, 1)",
                backgroundColor: "rgba(103, 126, 234, 0.1)",
                yAxisID: "y1",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "Volume (m¬≥)" },
                position: "left",
              },
              y1: {
                beginAtZero: true,
                title: { display: true, text: "Sess√µes" },
                position: "right",
                grid: { drawOnChartArea: false },
              },
            },
          },
        });
      }

      // Fetch supply data from API
      async function fetchSupplyData(days = 7) {
        try {
          if (!window.apiService) {
            console.warn("[Abastecimento] API Service n√£o dispon√≠vel");
            return {
              labels: generateDayLabels(days),
              volumes: Array(days).fill(0),
              sessions: Array(days).fill(0),
            };
          }

          // Buscar hist√≥rico de leituras para detectar abastecimento
          const readings = await window.apiService.getLatestReadings();
          const history = await Promise.all(
            ["RCON", "RCAV", "RB03", "IE01", "IE02"].map((id) =>
              window.apiService.getReadingHistory(
                window.SENSORS?.[id]?.sensor_id || id,
                days,
                "distance_cm"
              )
            )
          );

          // Processar dados para detectar abastecimento (aumento de volume)
          const labels = generateDayLabels(days);
          const volumes = Array(days).fill(0);
          const sessions = Array(days).fill(0);

          // Simplificado: usar dados das leituras
          history.forEach((sensorHistory, idx) => {
            sensorHistory.forEach((reading) => {
              const date = new Date(reading.datetime);
              const dayIndex =
                days -
                Math.floor(
                  (Date.now() - date.getTime()) / (1000 * 60 * 60 * 24)
                );
              if (dayIndex >= 0 && dayIndex < days) {
                volumes[dayIndex] += parseFloat(reading.valor || 0) / 100; // Converter para m¬≥
              }
            });
          });

          return { labels, volumes, sessions };
        } catch (error) {
          console.error("[Abastecimento] Erro ao buscar dados:", error);
          return {
            labels: generateDayLabels(days),
            volumes: Array(days).fill(0),
            sessions: Array(days).fill(0),
          };
        }
      }

      // Update supply status
      async function updateSupplyStatus() {
        try {
          if (!window.apiService) {
            console.warn("[Abastecimento] API Service n√£o dispon√≠vel");
            return;
          }

          // Buscar leituras atuais
          const readings = await window.apiService.getLatestReadings();
          if (!readings) return;

          // Buscar hist√≥rico recente para detectar tend√™ncia de aumento
          let isSupplying = false;
          let volumeIncrease = 0;
          let totalVolume = 0;
          let totalCapacity = 0;

          // Verificar hist√≥rico de cada sensor para detectar aumento de volume
          const sensors = window.SENSORS || {};
          for (const [id, sensor] of Object.entries(sensors)) {
            const reading = readings[id];
            if (!reading || !reading.distance_cm) continue;

            // Buscar hist√≥rico recente (√∫ltimas 2 horas) para detectar tend√™ncia
            try {
              const history = await window.apiService.getReadingHistory(
                sensor.sensor_id || id,
                1, // 1 dia
                "distance_cm"
              );

              if (history && history.length > 1) {
                // Comparar leitura mais antiga com a mais recente
                const oldest = parseFloat(
                  history[history.length - 1].valor || 0
                );
                const newest = parseFloat(reading.distance_cm || 0);

                // Se a dist√¢ncia diminuiu (volume aumentou), h√° abastecimento
                if (newest < oldest && oldest - newest > 5) {
                  // Diferen√ßa de pelo menos 5cm
                  isSupplying = true;
                  volumeIncrease += oldest - newest;
                }
              }
            } catch (error) {
              console.warn(
                `[Abastecimento] Erro ao buscar hist√≥rico de ${id}:`,
                error
              );
            }

            // Calcular volume total
            const volumeM3 = calculateVolumeM3(id, reading.distance_cm);
            totalVolume += volumeM3;

            const config = getReservoirConfig(id);
            if (config) {
              totalCapacity += config.volume_max_m3;
            }
          }

          const indicator = document.getElementById("supplyIndicator");
          const status = document.getElementById("supplyStatus");

          if (isSupplying) {
            indicator.className = "supply-indicator active";
            status.textContent = "Abastecendo";
            status.style.color = "var(--success-green)";

            if (!sessionStartTime) {
              sessionStartTime = Date.now();
              startDurationTimer();
            }
          } else {
            indicator.className = "supply-indicator inactive";
            status.textContent = "Inativo";
            status.style.color = "var(--text-muted)";

            if (sessionStartTime) {
              sessionStartTime = null;
              stopDurationTimer();
            }
          }

          // Atualizar timestamp do √∫ltimo abastecimento
          const lastSupplyTime =
            isSupplying && readings
              ? Object.values(readings).find((r) => r.timestamp)?.timestamp
              : null;
          if (lastSupplyTime) {
            const timeStr =
              typeof formatTime === "function"
                ? formatTime(lastSupplyTime)
                : new Date(lastSupplyTime).toLocaleTimeString("pt-BR");
            document.getElementById(
              "supplyTime"
            ).textContent = `√öltimo: ${timeStr}`;
          }

          const volumeToday = totalVolume.toFixed(1);
          const dailyTarget = 50;
          const progress = Math.min((totalVolume / dailyTarget) * 100, 100);

          document.getElementById(
            "volumeToday"
          ).textContent = `${volumeToday} m¬≥`;
          document.getElementById(
            "volumeProgress"
          ).style.width = `${progress}%`;

          // Calcular taxa m√©dia baseada no aumento de volume
          let avgRate = 0;
          if (isSupplying && volumeIncrease > 0) {
            // Assumir que o aumento ocorreu nas √∫ltimas horas
            avgRate = ((volumeIncrease / 100) * 1000) / 60; // Converter cm para litros/min
          }
          document.getElementById("avgRate").textContent = `${avgRate.toFixed(
            1
          )} L/min`;

          // Calcular tempo total (simplificado)
          const totalMinutes =
            avgRate > 0 ? Math.floor((totalVolume * 1000) / avgRate) : 0;
          const totalHours = Math.floor(totalMinutes / 60);
          const remainingMins = totalMinutes % 60;
          document.getElementById(
            "totalTime"
          ).textContent = `${totalHours}h ${remainingMins}min`;

          // Update prediction
          const currentLevel =
            totalCapacity > 0 ? (totalVolume / totalCapacity) * 100 : 0;
          const remaining = Math.max(0, totalCapacity - totalVolume).toFixed(1);

          document.getElementById(
            "currentLevel"
          ).textContent = `${currentLevel.toFixed(0)}%`;
          document.getElementById(
            "remainingVolume"
          ).textContent = `${remaining} m¬≥`;

          // Determinar reservat√≥rio alvo (o que est√° mais vazio)
          let targetReservoir = "RCON";
          let minLevel = 100;
          Object.entries(readings).forEach(([id, reading]) => {
            if (reading.distance_cm) {
              const config = getReservoirConfig(id);
              if (config) {
                const percent = getVolumePercent(id, reading.distance_cm);
                if (percent < minLevel) {
                  minLevel = percent;
                  targetReservoir = id;
                }
              }
            }
          });
          document.getElementById("targetReservoir").textContent =
            targetReservoir;

          // Estimar tempo restante para encher todos os reservat√≥rios
          if (isSupplying && avgRate > 0 && remaining > 0) {
            const remainingMinutes = (parseFloat(remaining) * 1000) / avgRate;
            const estimated = new Date(Date.now() + remainingMinutes * 60000);
            document.getElementById("estimatedTime").textContent =
              estimated.toLocaleTimeString("pt-BR", {
                hour: "2-digit",
                minute: "2-digit",
              });
          } else {
            document.getElementById("estimatedTime").textContent = "--:--";
          }
        } catch (error) {
          console.error("[Abastecimento] Erro ao atualizar status:", error);
        }
      }

      // Fun√ß√£o auxiliar para calcular volume (se n√£o estiver dispon√≠vel globalmente)
      function calculateVolumeM3(sensorId, distance_cm) {
        const config = getReservoirConfig(sensorId);
        if (!config || !distance_cm || distance_cm <= 0) return 0;

        // nivel_atual_cm = nivel_max_cm - distancia_cm + offset_sensor_cm
        // offset_sensor_cm: dist√¢ncia do sensor acima do n√≠vel m√°ximo (padr√£o: 20.0 cm)
        const offset_sensor_cm = config.offset_sensor_cm || 20.0;
        const nivel_cm = config.nivel_max_cm - distance_cm + offset_sensor_cm;

        if (nivel_cm <= 0) return 0;

        // Volume = √°rea_base √ó (n√≠vel_cm / 100) para converter para metros
        const volume_m3 = config.area_m2 * (nivel_cm / 100);

        // Limitar ao volume m√°ximo e retornar n√∫mero (n√£o string)
        return Math.min(volume_m3, config.volume_max_m3);
      }

      function getReservoirConfig(sensorId) {
        // Usar fun√ß√£o global se dispon√≠vel
        if (typeof window.getReservoirConfig === "function") {
          return window.getReservoirConfig(sensorId);
        }

        const reservoirs = {
          // Cil√≠ndricos: nivel_max = 450cm, volume_max = 80m3
          // area_m2 = volume_max / (nivel_max / 100) = 80 / 4.5 = 17.777... m¬≤
          RCON: {
            tipo: "cilindrico",
            nivel_max_cm: 450,
            volume_max_m3: 80.0,
            area_m2: 80.0 / 4.5, // Calculado: 17.777...
            offset_sensor_cm: 20.0, // Dist√¢ncia m√≠nima do sensor acima do n√≠vel m√°ximo
          },
          RCAV: {
            tipo: "cilindrico",
            nivel_max_cm: 450,
            volume_max_m3: 80.0,
            area_m2: 80.0 / 4.5, // Calculado: 17.777...
            offset_sensor_cm: 20.0, // Dist√¢ncia m√≠nima do sensor acima do n√≠vel m√°ximo
          },
          RB03: {
            tipo: "cilindrico",
            nivel_max_cm: 450,
            volume_max_m3: 80.0,
            area_m2: 80.0 / 4.5, // Calculado: 17.777...
            offset_sensor_cm: 20.0, // Dist√¢ncia m√≠nima do sensor acima do n√≠vel m√°ximo
          },
          // Retangulares: nivel_max = 240cm, volume_max = 250.0m3
          // area_m2 = volume_max / (nivel_max / 100) = 250 / 2.4 = 104.166... m¬≤
          IE01: {
            tipo: "retangular",
            nivel_max_cm: 240,
            volume_max_m3: 250.0,
            area_m2: 250.0 / 2.4, // Calculado: 104.166...
            offset_sensor_cm: 20.0, // Dist√¢ncia m√≠nima do sensor acima do n√≠vel m√°ximo
          },
          IE02: {
            tipo: "retangular",
            nivel_max_cm: 240,
            volume_max_m3: 250.0,
            area_m2: 250.0 / 2.4, // Calculado: 104.166...
            offset_sensor_cm: 20.0, // Dist√¢ncia m√≠nima do sensor acima do n√≠vel m√°ximo
          },
        };
        return reservoirs[sensorId];
      }

      function getVolumePercent(sensorId, distance_cm) {
        // Usar fun√ß√£o global se dispon√≠vel
        if (typeof window.getVolumePercent === "function") {
          return window.getVolumePercent(sensorId, distance_cm);
        }

        const config = getReservoirConfig(sensorId);
        if (!config || !distance_cm || distance_cm <= 0) return 0;

        const volume_atual = calculateVolumeM3(sensorId, distance_cm);
        const volume_total = config.volume_max_m3;

        if (volume_total <= 0) return 0;

        const percentual = (volume_atual / volume_total) * 100;
        return Math.max(0, Math.min(100, percentual));
      }

      function startDurationTimer() {
        durationInterval = setInterval(() => {
          if (sessionStartTime) {
            const elapsed = Date.now() - sessionStartTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);

            document.getElementById("supplyDuration").textContent = `${String(
              hours
            ).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(
              seconds
            ).padStart(2, "0")}`;
          }
        }, 1000);
      }

      function stopDurationTimer() {
        if (durationInterval) {
          clearInterval(durationInterval);
          durationInterval = null;
        }
        document.getElementById("supplyDuration").textContent = "00:00:00";
      }

      function generateDayLabels(days) {
        const labels = [];
        for (let i = days - 1; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          labels.push(
            date.toLocaleDateString("pt-BR", {
              day: "2-digit",
              month: "2-digit",
            })
          );
        }
        return labels;
      }

      // Carregar eventos recentes
      async function loadRecentEvents() {
        try {
          if (!window.apiService) {
            return;
          }

          // Buscar alertas relacionados a abastecimento e consumo
          const alerts = await window.apiService.getAlerts({ limit: 20 });
          const eventList = document.getElementById("eventList");

          if (!eventList) return;

          if (!alerts || alerts.length === 0) {
            eventList.innerHTML =
              '<li style="text-align: center; color: #999; padding: 20px;">Nenhum evento recente</li>';
            return;
          }

          // Filtrar e formatar eventos
          const events = alerts
            .filter(
              (a) =>
                a.tipo === "supply" ||
                a.tipo === "consumption" ||
                a.tipo === "leak" ||
                a.mensagem?.toLowerCase().includes("abastecimento") ||
                a.mensagem?.toLowerCase().includes("consumo")
            )
            .slice(0, 10)
            .map((alert) => {
              const timestamp = alert.datetime
                ? new Date(alert.datetime)
                : new Date();
              const timeStr =
                typeof formatDateTime === "function"
                  ? formatDateTime(alert.datetime)
                  : timestamp.toLocaleString("pt-BR");

              const eventClass =
                alert.tipo === "supply" ||
                alert.mensagem?.toLowerCase().includes("abastecimento")
                  ? "supply"
                  : alert.tipo === "leak"
                  ? "leak"
                  : "consumption";

              const icon =
                eventClass === "supply"
                  ? "üü¢"
                  : eventClass === "leak"
                  ? "üî¥"
                  : "üü°";

              return `
                            <li class="event-item ${eventClass}">
                                <div class="event-time">${timeStr}</div>
                                <div class="event-desc">${icon} ${
                alert.mensagem || alert.tipo || "Evento"
              } - ${alert.elemento_id || alert.sensor_id || "N/A"}</div>
                            </li>
                        `;
            });

          if (events.length === 0) {
            eventList.innerHTML =
              '<li style="text-align: center; color: #999; padding: 20px;">Nenhum evento de abastecimento/consumo recente</li>';
          } else {
            eventList.innerHTML = events.join("");
          }
        } catch (error) {
          console.error("[Abastecimento] Erro ao carregar eventos:", error);
        }
      }

      // Initialize
      async function init() {
        await initSupplyChart();
        await updateSupplyStatus();
        await loadRecentEvents();

        // Update every 10 seconds
        setInterval(updateSupplyStatus, 10000);
        // Update events every 30 seconds
        setInterval(loadRecentEvents, 30000);
      }

      init();
    </script>
  </body>
</html>
