<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Visual - AGUADA</title>
    <link rel="stylesheet" href="assets/style.css" />
    <link rel="stylesheet" href="assets/loading-states.css" />
    <style>
      .diagram-container {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        overflow-x: auto;
      }

      .hydraulic-diagram {
        min-width: 1200px;
        position: relative;
        height: 800px;
        background: linear-gradient(to bottom, #e3f2fd 0%, #bbdefb 100%);
        border-radius: 8px;
        border: 2px solid #2196f3;
      }

      .reservoir {
        position: absolute;
        text-align: center;
        cursor: pointer;
        transition: transform 0.3s;
      }

      .reservoir:hover {
        transform: scale(1.05);
      }

      .reservoir-tank {
        width: 120px;
        height: 180px;
        background: linear-gradient(to bottom, #0d47a1 0%, #1976d2 100%);
        border: 3px solid #0d47a1;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
      }

      .reservoir-level {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, #2196f3, #64b5f6);
        transition: height 0.5s ease;
        border-radius: 0 0 5px 5px;
      }

      .reservoir-label {
        margin-top: 8px;
        font-weight: bold;
        color: #0d47a1;
      }

      .reservoir-value {
        font-size: 20px;
        color: #1976d2;
        margin-top: 4px;
      }

      .pipe {
        position: absolute;
        background: #424242;
        z-index: 1;
      }

      .pipe-horizontal {
        height: 4px;
      }

      .pipe-vertical {
        width: 4px;
      }

      .valve {
        position: absolute;
        width: 30px;
        height: 30px;
        background: #fff;
        border: 3px solid #424242;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        z-index: 10;
        cursor: pointer;
      }

      .valve.open {
        background: #4caf50;
        color: white;
      }

      .valve.closed {
        background: #f44336;
        color: white;
      }

      .pump {
        position: absolute;
        width: 60px;
        height: 60px;
        background: #ff9800;
        border: 3px solid #e65100;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        z-index: 10;
        cursor: pointer;
      }

      .pump.active {
        background: #4caf50;
        animation: rotate 2s linear infinite;
      }

      @keyframes rotate {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .flow-indicator {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #2196f3;
        border-radius: 50%;
        animation: flow 2s linear infinite;
      }

      @keyframes flow {
        0%,
        100% {
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
      }

      .legend {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .legend-color {
        width: 30px;
        height: 20px;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="admin-header">
      <div class="admin-header-top">
        <h1>üîß Painel Visual Hidr√°ulico - AGUADA</h1>
        <div class="status-indicator">
          <div class="status-dot"></div>
          <span>‚óè Online</span>
        </div>
      </div>
      <nav class="admin-nav">
        <a href="index.html">Dashboard</a>
        <a href="mapa.html">Mapa</a>
        <a href="painel.html" class="active">Painel Visual</a>
        <a href="dados.html">Dados</a>
        <a href="consumo.html">Consumo</a>
        <a href="abastecimento.html">Abastecimento</a>
        <a href="manutencao.html">Manuten√ß√£o</a>
        <a href="history.html">Hist√≥rico</a>
        <a href="alerts.html">Alertas</a>
        <a href="config.html">Configura√ß√µes</a>
        <a href="system.html">Sistema</a>
        <a href="documentacao.html">Docs</a>
      </nav>
    </div>

    <div class="main-container">
      <div class="diagram-container">
        <h2 style="color: var(--primary-blue); margin-bottom: 20px">
          Diagrama de Fluxo Hidr√°ulico - CMASM
        </h2>

        <div class="hydraulic-diagram" id="diagram">
          <!-- Reservat√≥rios Superiores (Castelos) -->
          <div class="reservoir" style="top: 50px; left: 150px" data-id="RCON">
            <div class="reservoir-tank">
              <div
                class="reservoir-level"
                id="level-RCON"
                style="height: 0%"
              ></div>
            </div>
            <div class="reservoir-label">RCON (Consumo)</div>
            <div class="reservoir-value" id="value-RCON">0%</div>
          </div>

          <div class="reservoir" style="top: 50px; left: 400px" data-id="RCAV">
            <div class="reservoir-tank">
              <div
                class="reservoir-level"
                id="level-RCAV"
                style="height: 0%"
              ></div>
            </div>
            <div class="reservoir-label">RCAV (Inc√™ndio)</div>
            <div class="reservoir-value" id="value-RCAV">0%</div>
          </div>

          <!-- Casa de Bombas -->
          <div class="reservoir" style="top: 300px; left: 550px" data-id="RB03">
            <div class="reservoir-tank">
              <div
                class="reservoir-level"
                id="level-RB03"
                style="height: 0%"
              ></div>
            </div>
            <div class="reservoir-label">RB03 (Casa Bombas)</div>
            <div class="reservoir-value" id="value-RB03">0%</div>
          </div>

          <!-- Bombas -->
          <div
            class="pump"
            style="top: 400px; left: 570px"
            id="pump-B03E"
            title="Bomba El√©trica B03E"
          >
            ‚ö°
          </div>
          <div
            class="pump"
            style="top: 400px; left: 640px"
            id="pump-B03D"
            title="Bomba Diesel B03D"
          >
            üõ¢Ô∏è
          </div>

          <!-- Cisternas -->
          <div class="reservoir" style="top: 550px; left: 850px" data-id="IE01">
            <div class="reservoir-tank">
              <div
                class="reservoir-level"
                id="level-IE01"
                style="height: 0%"
              ></div>
            </div>
            <div class="reservoir-label">IE01 (Cisterna)</div>
            <div class="reservoir-value" id="value-IE01">0%</div>
          </div>

          <div
            class="reservoir"
            style="top: 550px; left: 1000px"
            data-id="IE02"
          >
            <div class="reservoir-tank">
              <div
                class="reservoir-level"
                id="level-IE02"
                style="height: 0%"
              ></div>
            </div>
            <div class="reservoir-label">IE02 (Cisterna)</div>
            <div class="reservoir-value" id="value-IE02">0%</div>
          </div>

          <!-- Pipes (simplified representation) -->
          <div
            class="pipe pipe-vertical"
            style="left: 208px; top: 230px; height: 100px"
          ></div>
          <div
            class="pipe pipe-vertical"
            style="left: 458px; top: 230px; height: 100px"
          ></div>
          <div
            class="pipe pipe-horizontal"
            style="left: 208px; top: 330px; width: 252px"
          ></div>
          <div
            class="pipe pipe-vertical"
            style="left: 610px; top: 330px; height: 70px"
          ></div>
          <div
            class="pipe pipe-vertical"
            style="left: 610px; top: 460px; height: 120px"
          ></div>
          <div
            class="pipe pipe-horizontal"
            style="left: 610px; top: 580px; width: 260px"
          ></div>
          <div
            class="pipe pipe-horizontal"
            style="left: 870px; top: 580px; width: 180px"
          ></div>

          <!-- Valves -->
          <div
            class="valve closed"
            style="left: 193px; top: 260px"
            id="valve-RCON-in"
            title="V√°lvula Entrada RCON"
          >
            V
          </div>
          <div
            class="valve closed"
            style="left: 443px; top: 260px"
            id="valve-RCAV-in"
            title="V√°lvula Entrada RCAV"
          >
            V
          </div>
          <div
            class="valve closed"
            style="left: 595px; top: 480px"
            id="valve-RB03-out"
            title="V√°lvula Sa√≠da RB03"
          >
            V
          </div>
        </div>

        <div class="legend">
          <div class="legend-item">
            <div
              class="legend-color"
              style="background: linear-gradient(to top, #2196f3, #64b5f6)"
            ></div>
            <span>N√≠vel de √Ågua</span>
          </div>
          <div class="legend-item">
            <div
              class="legend-color"
              style="background: #4caf50; border-radius: 50%"
            ></div>
            <span>V√°lvula Aberta / Bomba Ativa</span>
          </div>
          <div class="legend-item">
            <div
              class="legend-color"
              style="background: #f44336; border-radius: 50%"
            ></div>
            <span>V√°lvula Fechada / Bomba Inativa</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #424242"></div>
            <span>Tubula√ß√£o</span>
          </div>
        </div>
      </div>

      <div class="stats-footer">
        <div class="stat">
          <div class="stat-value" id="totalVolume">0 m¬≥</div>
          <div class="stat-label">Volume Total</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="avgLevel">0%</div>
          <div class="stat-label">N√≠vel M√©dio</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="flowRate">0 L/h</div>
          <div class="stat-label">Vaz√£o Estimada</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="systemStatus">Normal</div>
          <div class="stat-label">Status do Sistema</div>
        </div>
      </div>
    </div>

    <script src="assets/layout.js"></script>
    <script src="assets/api-service.js"></script>
    <script src="assets/ui-utils.js"></script>
    <script src="assets/app.js"></script>
    <script>
      // Update diagram with real-time data
      function updateDiagram() {
        if (!window.latestReadings || !window.SENSORS) {
          console.warn(
            "[Painel] Dados n√£o dispon√≠veis para atualizar diagrama"
          );
          return;
        }

        // Update reservoir levels
        Object.keys(window.SENSORS).forEach((sensorId) => {
          const reading = window.latestReadings[sensorId];
          if (
            !reading ||
            reading.distance_cm === null ||
            reading.distance_cm === undefined
          ) {
            return;
          }

          const percent = getVolumePercent(sensorId, reading.distance_cm);

          // Update tank level
          const levelEl = document.getElementById(`level-${sensorId}`);
          const valueEl = document.getElementById(`value-${sensorId}`);

          if (levelEl) {
            levelEl.style.height = `${percent}%`;
            const color = getGaugeColor(percent);
            levelEl.style.background = `linear-gradient(to top, ${color}, ${color}88)`;
          }
          if (valueEl) {
            valueEl.textContent = `${percent.toFixed(1)}%`;
          }

          // Update valve states
          if (reading.valve_in !== undefined && reading.valve_in !== null) {
            const valveEl = document.getElementById(`valve-${sensorId}-in`);
            if (valveEl) {
              const isOpen =
                reading.valve_in === 1 ||
                reading.valve_in === "1" ||
                reading.valve_in === true;
              valveEl.className = isOpen ? "valve open" : "valve closed";
              valveEl.textContent = isOpen ? "A" : "F";
            }
          }
        });

        // Calculate stats
        let totalVolume = 0;
        let avgLevel = 0;
        let count = 0;

        Object.keys(window.SENSORS).forEach((sensorId) => {
          const reading = window.latestReadings[sensorId];
          if (
            !reading ||
            reading.distance_cm === null ||
            reading.distance_cm === undefined
          ) {
            return;
          }

          const percent = getVolumePercent(sensorId, reading.distance_cm);
          const volume = calculateVolumeM3(sensorId, reading.distance_cm);

          avgLevel += percent;
          totalVolume += volume;
          count++;
        });

        if (count > 0) {
          avgLevel /= count;
        }

        // Update footer stats
        const totalVolumeEl = document.getElementById("totalVolume");
        const avgLevelEl = document.getElementById("avgLevel");
        const systemStatusEl = document.getElementById("systemStatus");

        if (totalVolumeEl) {
          totalVolumeEl.textContent = `${totalVolume.toFixed(1)} m¬≥`;
        }
        if (avgLevelEl) {
          avgLevelEl.textContent = `${avgLevel.toFixed(1)}%`;
        }

        // Determine system status
        let status = "Normal";
        let statusColor = "#10b981";

        if (avgLevel < 30) {
          status = "Cr√≠tico";
          statusColor = "#ef4444";
        } else if (avgLevel < 50) {
          status = "Aten√ß√£o";
          statusColor = "#f59e0b";
        }

        if (systemStatusEl) {
          systemStatusEl.textContent = status;
          systemStatusEl.style.color = statusColor;
        }
      }

      // Poll data and update diagram
      let pollInterval = null;
      let isPolling = false;
      let pollStarted = false; // Flag para evitar m√∫ltiplas inicializa√ß√µes

      async function pollData() {
        // Evitar m√∫ltiplas chamadas simult√¢neas
        if (isPolling) {
          console.log("[Painel] Polling j√° em andamento, ignorando");
          return;
        }

        isPolling = true;
        try {
          await fetchLatestReadings();
          updateDiagram();
        } catch (error) {
          console.error("[Painel] Erro ao atualizar:", error);
        } finally {
          isPolling = false;
        }
      }

      function startPolling() {
        // Verificar se j√° foi iniciado
        if (pollStarted) {
          console.warn("[Painel] Polling j√° iniciado, ignorando");
          return;
        }

        pollStarted = true;

        // Limpar qualquer intervalo anterior
        if (pollInterval) {
          clearInterval(pollInterval);
          pollInterval = null;
        }

        console.log(
          "[Painel] Iniciando polling (intervalo:",
          POLL_INTERVAL / 1000,
          "s)"
        );

        // Primeira chamada imediata
        pollData();

        // Polling peri√≥dico
        pollInterval = setInterval(pollData, POLL_INTERVAL);
      }

      function stopPolling() {
        console.log("[Painel] Parando polling");
        if (pollInterval) {
          clearInterval(pollInterval);
          pollInterval = null;
        }
        pollStarted = false;
        isPolling = false;
      }

      // Aguardar DOM ready e API Service
      function initializePage() {
        if (!window.apiService) {
          console.warn("[Painel] API Service n√£o dispon√≠vel ainda");
          return false;
        }

        if (
          document.readyState !== "complete" &&
          document.readyState !== "interactive"
        ) {
          console.warn("[Painel] DOM n√£o pronto ainda");
          return false;
        }

        startPolling();
        return true;
      }

      // Tentar inicializar quando DOM estiver pronto
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
          setTimeout(initializePage, 100);
        });
      } else {
        setTimeout(initializePage, 100);
      }

      // Cleanup
      window.addEventListener("beforeunload", stopPolling);
      window.addEventListener("pagehide", stopPolling);
    </script>
  </body>
</html>
