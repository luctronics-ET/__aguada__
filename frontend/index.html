<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGUADA - Dashboard Administrativo</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/loading-states.css">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            background: #f0f2f5;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #1a1a1a;
        }

        /* Header Administrativo Melhorado */
        .admin-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .admin-header-top {
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.12);
        }

        .admin-header-top h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.3px;
        }

        .admin-header-top .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
            animation: pulse-dot 2s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* Navbar Compacta e Profissional */
        .admin-nav {
            background: rgba(0,0,0,0.06);
            padding: 0 24px;
            display: flex;
            gap: 1px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .admin-nav::-webkit-scrollbar {
            display: none;
        }

        .admin-nav a {
            padding: 10px 16px;
            color: rgba(255,255,255,0.85);
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            white-space: nowrap;
            position: relative;
        }

        .admin-nav a:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .admin-nav a.active {
            border-bottom-color: #10b981;
            color: white;
            background: rgba(255,255,255,0.08);
        }

        /* Container principal */
        .main-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Layout Integrado: Diagrama + Cards lado a lado */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 1.8fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1600px) {
            .dashboard-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Se√ß√£o do Diagrama */
        .diagram-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 24px;
            min-height: 700px;
        }

        .diagram-section h2 {
            margin: 0 0 20px 0;
            font-size: 18px;
            font-weight: 600;
            color: #1e3a5f;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .diagram-section h2::before {
            content: 'üìä';
            font-size: 20px;
        }

        .hydraulic-diagram {
            position: relative;
            height: 650px;
            background: linear-gradient(to bottom, #e8f4f8 0%, #d0e8f0 100%);
            border-radius: 8px;
            border: 2px solid #b0d4e8;
            overflow: hidden;
        }

        /* Reservat√≥rios no diagrama */
        .reservoir-visual {
            position: absolute;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 5;
        }

        .reservoir-visual:hover {
            transform: scale(1.08);
            z-index: 10;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.2));
        }

        .reservoir-tank-visual {
            width: 110px;
            height: 160px;
            background: linear-gradient(to bottom, #1e3a5f 0%, #2d4a6f 100%);
            border: 3px solid #1e3a5f;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            margin: 0 auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .reservoir-level-visual {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, #2196f3, #64b5f6);
            transition: height 0.6s ease, background 0.6s ease;
            border-radius: 0 0 5px 5px;
        }

        .reservoir-label-visual {
            margin-top: 8px;
            font-weight: 600;
            font-size: 12px;
            color: #1e3a5f;
        }

        .reservoir-value-visual {
            font-size: 14px;
            font-weight: 700;
            color: #2d4a6f;
            margin-top: 3px;
        }

        .reservoir-volume-visual {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
        }

        /* Cards Integrados (lado direito) */
        .cards-section {
            display: flex;
            flex-direction: column;
            gap: 14px;
            max-height: 700px;
            overflow-y: auto;
            padding-right: 6px;
        }

        .cards-section::-webkit-scrollbar {
            width: 5px;
        }

        .cards-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .cards-section::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .cards-section::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .reservoir-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .reservoir-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            border-color: #e5e7eb;
        }

        .reservoir-card.selected {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
        }

        .card-header {
            padding: 14px 18px;
            font-weight: 600;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .card-header.rcon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-header.rcav { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .card-header.rb03 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .card-header.ie01 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .card-header.ie02 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }

        .card-status {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            background: rgba(255,255,255,0.25);
            font-weight: 500;
            backdrop-filter: blur(4px);
        }

        .card-body {
            padding: 18px;
        }

        .volume-display {
            text-align: center;
            margin-bottom: 18px;
            padding-bottom: 18px;
            border-bottom: 1px solid #e5e7eb;
        }

        .volume-percent {
            font-size: 38px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 5px;
            letter-spacing: -1px;
        }

        .volume-m3 {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
            margin-top: 3px;
        }

        .volume-gauge {
            width: 100%;
            height: 12px;
            background: #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 12px;
        }

        .volume-gauge-fill {
            height: 100%;
            transition: width 0.6s ease, background 0.6s ease;
            border-radius: 6px;
        }

        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 14px;
        }

        .data-cell {
            background: #f9fafb;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            transition: all 0.2s;
        }

        .data-cell:hover {
            background: #f3f4f6;
            transform: translateX(2px);
        }

        .data-cell-label {
            font-size: 9px;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .data-cell-value {
            font-size: 14px;
            font-weight: 600;
            color: #1e3a5f;
        }

        /* Barra de Estat√≠sticas */
        .stats-bar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 20px 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: #f9fafb;
            transition: all 0.2s;
        }

        .stat-item:hover {
            background: #f3f4f6;
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1e3a5f;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }

        .stat-label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.8px;
        }

        /* Estados de loading/erro */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
            font-size: 14px;
        }

        .error-state {
            text-align: center;
            padding: 60px 20px;
            color: #ef4444;
        }

        /* Tubula√ß√µes no diagrama */
        .pipe-visual {
            position: absolute;
            background: #424242;
            z-index: 1;
        }

        .pipe-horizontal {
            height: 4px;
        }

        .pipe-vertical {
            width: 4px;
        }

        /* Responsividade */
        @media (max-width: 1200px) {
            .dashboard-layout {
                grid-template-columns: 1fr;
            }
            
            .cards-section {
                max-height: none;
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="admin-header-top">
            <h1>üíß AGUADA - Sistema de Monitoramento Hidr√°ulico</h1>
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">‚óè Online</span>
            </div>
        </div>
        <nav class="admin-nav">
            <a href="index.html" class="active">Dashboard</a>
            <a href="mapa.html">Mapa</a>
            <a href="painel.html">Painel Visual</a>
            <a href="dados.html">Dados</a>
            <a href="consumo.html">Consumo</a>
            <a href="abastecimento.html">Abastecimento</a>
            <a href="manutencao.html">Manuten√ß√£o</a>
            <a href="history.html">Hist√≥rico</a>
            <a href="alerts.html">Alertas</a>
            <a href="config.html">Configura√ß√µes</a>
            <a href="system.html">Sistema</a>
        </nav>
    </div>

    <div class="main-container">
        <div class="dashboard-layout">
            <!-- Diagrama Visual Integrado -->
            <div class="diagram-section">
                <h2>Diagrama Hidr√°ulico - CMASM</h2>
                <div class="hydraulic-diagram" id="hydraulicDiagram">
                    <!-- Reservat√≥rios ser√£o renderizados aqui -->
                </div>
            </div>

            <!-- Cards dos Reservat√≥rios (lado direito) -->
            <div class="cards-section" id="cardsSection">
                <div class="loading-state">‚è≥ Carregando dados dos sensores...</div>
            </div>
        </div>

        <!-- Barra de Estat√≠sticas -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="totalSensors">0</div>
                <div class="stat-label">Sensores Ativos</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalVolume">0.0 m¬≥</div>
                <div class="stat-label">Volume Total</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avgLevel">0%</div>
                <div class="stat-label">N√≠vel M√©dio</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lastSync">-</div>
                <div class="stat-label">√öltima Sincroniza√ß√£o</div>
            </div>
        </div>
    </div>

    <script src="assets/api-service.js"></script>
    <script src="assets/ui-utils.js"></script>
    <script src="assets/app.js"></script>
    <script>
        // Fun√ß√µes de c√°lculo de volume (definidas antes de serem usadas)
        function getReservoirConfig(sensorId) {
            // √Årea √© calculada automaticamente: area_m2 = volume_max_m3 / (nivel_max_cm / 100)
            const reservoirs = {
                // Cil√≠ndricos: nivel_max = 450cm, volume_max = 80m3
                'RCON': { 
                    tipo: 'cilindrico', 
                    nivel_max_cm: 450, 
                    volume_max_m3: 80.0,
                    area_m2: 80.0 / 4.5,  // Calculado: 17.777...
                    offset_sensor_cm: 20.0  // Dist√¢ncia m√≠nima do sensor acima do n√≠vel m√°ximo
                },
                'RCAV': { 
                    tipo: 'cilindrico', 
                    nivel_max_cm: 450, 
                    volume_max_m3: 80.0,
                    area_m2: 80.0 / 4.5,  // Calculado: 17.777...
                    offset_sensor_cm: 20.0  // Dist√¢ncia m√≠nima do sensor acima do n√≠vel m√°ximo
                },
                'RB03': { 
                    tipo: 'cilindrico', 
                    nivel_max_cm: 450, 
                    volume_max_m3: 80.0,
                    area_m2: 80.0 / 4.5,  // Calculado: 17.777...
                    offset_sensor_cm: 20.0  // Dist√¢ncia m√≠nima do sensor acima do n√≠vel m√°ximo
                },
                // Retangulares: nivel_max = 240cm, volume_max = 250.0m3
                'IE01': { 
                    tipo: 'retangular', 
                    nivel_max_cm: 240, 
                    volume_max_m3: 250.0,
                    area_m2: 250.0 / 2.4,  // Calculado: 104.166...
                    offset_sensor_cm: 20.0  // Dist√¢ncia m√≠nima do sensor acima do n√≠vel m√°ximo
                },
                'IE02': { 
                    tipo: 'retangular', 
                    nivel_max_cm: 240, 
                    volume_max_m3: 250.0,
                    area_m2: 250.0 / 2.4,  // Calculado: 104.166...
                    offset_sensor_cm: 20.0  // Dist√¢ncia m√≠nima do sensor acima do n√≠vel m√°ximo
                }
            };
            return reservoirs[sensorId] || null;
        }

        function calculateVolumeM3(sensorId, distance_cm) {
            // Usar fun√ß√£o global se dispon√≠vel (de app.js)
            if (typeof window.calculateVolumeM3 === 'function') {
                return window.calculateVolumeM3(sensorId, distance_cm);
            }
            
            const reservoir = getReservoirConfig(sensorId);
            if (!reservoir) return 0;
            
            // Aceitar 0 como valor v√°lido (reservat√≥rio vazio)
            if (distance_cm === null || distance_cm === undefined) return 0;
            
            const distanceNum = Number(distance_cm);
            if (isNaN(distanceNum) || distanceNum < 0) return 0;
            
            // nivel_atual_cm = nivel_max_cm - distancia_cm + offset_sensor_cm
            // offset_sensor_cm: dist√¢ncia do sensor acima do n√≠vel m√°ximo (padr√£o: 20.0 cm)
            const offset_sensor_cm = reservoir.offset_sensor_cm || 20.0;
            const nivel_cm = reservoir.nivel_max_cm - distanceNum + offset_sensor_cm;
            
            if (nivel_cm <= 0) return 0;
            
            // Volume = √°rea_base √ó (n√≠vel_cm / 100) para converter para metros
            const volume_m3 = reservoir.area_m2 * (nivel_cm / 100);
            
            // Limitar ao volume m√°ximo e garantir n√£o-negativo
            return Math.max(0, Math.min(volume_m3, reservoir.volume_max_m3));
        }

        function getVolumePercent(sensorId, distance_cm) {
            // Usar fun√ß√£o global se dispon√≠vel (de app.js)
            if (typeof window.getVolumePercent === 'function') {
                return window.getVolumePercent(sensorId, distance_cm);
            }
            
            const reservoir = getReservoirConfig(sensorId);
            if (!reservoir) return 0;
            
            // Aceitar 0 como v√°lido
            if (distance_cm === null || distance_cm === undefined) return 0;
            
            const volume_atual = calculateVolumeM3(sensorId, distance_cm);
            const volume_total = reservoir.volume_max_m3;
            
            if (volume_total <= 0) return 0;
            
            const percentual = (volume_atual / volume_total) * 100;
            return Math.max(0, Math.min(100, percentual));
        }

        // Configura√ß√£o de posicionamento dos reservat√≥rios no diagrama
        const RESERVOIR_POSITIONS = {
            'RCON': { top: '50px', left: '150px' },
            'RCAV': { top: '50px', left: '400px' },
            'RB03': { top: '300px', left: '550px' },
            'IE01': { top: '450px', left: '850px' },
            'IE02': { top: '450px', left: '1000px' }
        };

        // Renderizar diagrama hidr√°ulico
        function renderDiagram() {
            const diagram = document.getElementById('hydraulicDiagram');
            if (!diagram) return;

            const sensors = window.SENSORS || SENSORS || {};
            if (!sensors || Object.keys(sensors).length === 0) return;

            const latestReadings = window.latestReadings || {};
            if (!latestReadings || Object.keys(latestReadings).length === 0) {
                diagram.innerHTML = '<div class="loading-state">‚è≥ Aguardando dados dos sensores...</div>';
                return;
            }

            let html = '';
            Object.entries(sensors).forEach(([id, sensor]) => {
                const reading = latestReadings[id] || { distance_cm: null, timestamp: null };
                const pos = RESERVOIR_POSITIONS[id] || { top: '100px', left: '100px' };
                
                const distance_cm = reading.distance_cm !== null && reading.distance_cm !== undefined 
                    ? reading.distance_cm 
                    : null;
                const volumePercent = getVolumePercent(id, distance_cm);
                const volumeM3 = calculateVolumeM3(id, distance_cm);
                const isOnline = reading.timestamp && (new Date() - new Date(reading.timestamp)) < 5 * 60 * 1000;
                
                const gaugeColor = volumePercent <= 20 ? '#ef4444' : 
                                  volumePercent <= 50 ? '#f59e0b' : '#10b981';

                html += `
                    <div class="reservoir-visual" style="top: ${pos.top}; left: ${pos.left};" data-id="${id}">
                        <div class="reservoir-tank-visual">
                            <div class="reservoir-level-visual" 
                                 style="height: ${volumePercent}%; background: linear-gradient(to top, ${gaugeColor}, ${gaugeColor}88);">
                            </div>
                        </div>
                        <div class="reservoir-label-visual">${sensor.name}</div>
                        <div class="reservoir-value-visual">${volumePercent.toFixed(1)}%</div>
                        <div class="reservoir-volume-visual">${volumeM3.toFixed(1)} m¬≥</div>
                    </div>
                `;
            });

            // Adicionar tubula√ß√µes (simplificado)
            html += `
                <div class="pipe-visual pipe-vertical" style="left: 200px; top: 200px; height: 100px;"></div>
                <div class="pipe-visual pipe-vertical" style="left: 450px; top: 200px; height: 100px;"></div>
                <div class="pipe-visual pipe-horizontal" style="left: 200px; top: 300px; width: 252px;"></div>
                <div class="pipe-visual pipe-vertical" style="left: 600px; top: 300px; height: 150px;"></div>
                <div class="pipe-visual pipe-horizontal" style="left: 600px; top: 450px; width: 260px;"></div>
            `;

            diagram.innerHTML = html;

            // Adicionar eventos de clique para destacar no diagrama
            diagram.querySelectorAll('.reservoir-visual').forEach(el => {
                el.addEventListener('click', () => {
                    const id = el.dataset.id;
                    document.querySelectorAll('.reservoir-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    const card = document.querySelector(`.reservoir-card[data-id="${id}"]`);
                    if (card) {
                        card.classList.add('selected');
                        card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                });
            });
        }

        // Renderizar cards dos reservat√≥rios
        function renderCards() {
            const cardsSection = document.getElementById('cardsSection');
            if (!cardsSection) {
                return;
            }

            // Garantir que SENSORS est√° dispon√≠vel
            const sensors = window.SENSORS || SENSORS || {};
            if (!sensors || Object.keys(sensors).length === 0) {
                cardsSection.innerHTML = '<div class="loading-state">‚è≥ Carregando configura√ß√£o dos sensores...</div>';
                return;
            }

            // Garantir que latestReadings existe (sempre renderizar cards, mesmo sem dados)
            const latestReadings = window.latestReadings || {};

            const cards = Object.entries(sensors).map(([id, sensor]) => {
                const reading = latestReadings[id] || {
                    distance_cm: null,
                    valve_in: 0,
                    valve_out: 0,
                    sound_in: 0,
                    battery: 5000,
                    rssi: -50,
                    timestamp: null
                };

                const distance_cm = reading.distance_cm !== null && reading.distance_cm !== undefined 
                    ? reading.distance_cm 
                    : null;
                const volumePercent = getVolumePercent(id, distance_cm);
                const volumeM3 = calculateVolumeM3(id, distance_cm);
                const isOnline = reading.timestamp && (new Date() - new Date(reading.timestamp)) < 5 * 60 * 1000;
                
                const gaugeColor = volumePercent <= 20 ? '#ef4444' : 
                                  volumePercent <= 50 ? '#f59e0b' : '#10b981';

                return `
                    <div class="reservoir-card" data-id="${id}">
                        <div class="card-header ${id.toLowerCase()}">
                            <span>${sensor.name}</span>
                            <span class="card-status">${isOnline ? '‚óè Online' : '‚óè Offline'}</span>
                        </div>
                        <div class="card-body">
                            <div class="volume-display">
                                <div class="volume-percent" style="color: ${gaugeColor}">
                                    ${volumePercent.toFixed(1)}%
                                </div>
                                <div class="volume-m3">${volumeM3.toFixed(1)} m¬≥</div>
                                <div class="volume-gauge">
                                    <div class="volume-gauge-fill" 
                                         style="width: ${volumePercent}%; background: ${gaugeColor};">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="data-grid">
                                <div class="data-cell">
                                    <div class="data-cell-label">Dist√¢ncia</div>
                                    <div class="data-cell-value">${distance_cm !== null && distance_cm !== undefined ? ((distance_cm / 100).toFixed(2) + ' m') : 'N/A'}</div>
                                </div>
                                <div class="data-cell">
                                    <div class="data-cell-label">Bateria</div>
                                    <div class="data-cell-value">${((reading.battery || 5000) / 1000).toFixed(1)} V</div>
                                </div>
                                <div class="data-cell">
                                    <div class="data-cell-label">V√°lvula Entrada</div>
                                    <div class="data-cell-value">${reading.valve_in ? 'üü¢ Aberta' : 'üî¥ Fechada'}</div>
                                </div>
                                <div class="data-cell">
                                    <div class="data-cell-label">V√°lvula Sa√≠da</div>
                                    <div class="data-cell-value">${reading.valve_out ? 'üü¢ Aberta' : 'üî¥ Fechada'}</div>
                                </div>
                                <div class="data-cell">
                                    <div class="data-cell-label">Fluxo</div>
                                    <div class="data-cell-value">${reading.sound_in ? 'üíß Sim' : '‚èπÔ∏è N√£o'}</div>
                                </div>
                                <div class="data-cell">
                                    <div class="data-cell-label">RSSI</div>
                                    <div class="data-cell-value">${reading.rssi || '-'} dBm</div>
                                </div>
                            </div>
                            
                            <div style="font-size: 10px; color: #9ca3af; text-align: right; margin-top: 10px;">
                                ${reading.timestamp ? `Atualizado: ${typeof formatTime === 'function' ? formatTime(reading.timestamp) : new Date(reading.timestamp).toLocaleTimeString('pt-BR')}` : 'Aguardando dados...'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            cardsSection.innerHTML = cards;

            // Adicionar eventos de clique nos cards para destacar no diagrama
            cardsSection.querySelectorAll('.reservoir-card').forEach(card => {
                card.addEventListener('click', () => {
                    const id = card.dataset.id;
                    document.querySelectorAll('.reservoir-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    
                    // Destacar no diagrama
                    document.querySelectorAll('.reservoir-visual').forEach(r => {
                        r.style.opacity = '0.6';
                        r.style.transform = 'scale(1)';
                    });
                    const diagramEl = document.querySelector(`.reservoir-visual[data-id="${id}"]`);
                    if (diagramEl) {
                        diagramEl.style.opacity = '1';
                        diagramEl.style.transform = 'scale(1.1)';
                    }
                });
            });
        }

        // Atualizar estat√≠sticas
        function updateStats() {
            const latestReadings = window.latestReadings || {};
            if (!latestReadings || Object.keys(latestReadings).length === 0) {
                // Mostrar zeros se n√£o houver dados
                document.getElementById('totalSensors').textContent = '0';
                document.getElementById('totalVolume').textContent = '0.0 m¬≥';
                document.getElementById('avgLevel').textContent = '0%';
                return;
            }

            const activeSensors = Object.values(latestReadings).filter(r => 
                r && r.timestamp && (new Date() - new Date(r.timestamp)) < 5 * 60 * 1000
            ).length;
            
            let totalVolume = 0;
            let totalPercent = 0;
            let count = 0;

            const sensors = window.SENSORS || SENSORS || {};
            Object.entries(sensors).forEach(([id, sensor]) => {
                const reading = latestReadings[id];
                if (!reading) return;
                
                const distance_cm = reading.distance_cm;
                const volumeM3 = calculateVolumeM3(id, distance_cm);
                const percent = getVolumePercent(id, distance_cm);
                
                totalVolume += volumeM3;
                totalPercent += percent;
                count++;
            });

            const avgPercent = count > 0 ? totalPercent / count : 0;

            const totalSensorsEl = document.getElementById('totalSensors');
            const totalVolumeEl = document.getElementById('totalVolume');
            const avgLevelEl = document.getElementById('avgLevel');
            const lastSyncEl = document.getElementById('lastSync');
            
            if (totalSensorsEl) totalSensorsEl.textContent = activeSensors;
            if (totalVolumeEl) totalVolumeEl.textContent = totalVolume.toFixed(1) + ' m¬≥';
            if (avgLevelEl) avgLevelEl.textContent = avgPercent.toFixed(1) + '%';
            
            if (lastSyncEl) {
                // Usar timestamp da √∫ltima leitura se dispon√≠vel
                const lastTimestamp = Object.values(latestReadings)
                    .filter(r => r && r.timestamp)
                    .map(r => new Date(r.timestamp).getTime())
                    .sort((a, b) => b - a)[0];
                
                if (lastTimestamp) {
                    if (typeof formatDateTime === 'function') {
                        lastSyncEl.textContent = formatDateTime(new Date(lastTimestamp));
                    } else {
                        lastSyncEl.textContent = new Date(lastTimestamp).toLocaleString('pt-BR');
                    }
                } else {
                    if (typeof formatDateTime === 'function') {
                        lastSyncEl.textContent = formatDateTime(new Date());
                    } else {
                        lastSyncEl.textContent = new Date().toLocaleString('pt-BR');
                    }
                }
            }
        }

        // Atualizar status do sistema
        async function updateSystemStatus() {
            // Verificar status via API se dispon√≠vel
            let isOnline = false;
            
            if (window.apiService) {
                try {
                    isOnline = await window.apiService.isOnline();
                } catch (error) {
                    console.warn('[Dashboard] Erro ao verificar status:', error);
                    // Fallback: verificar pelas leituras
                    const latestReadings = window.latestReadings || {};
                    isOnline = Object.values(latestReadings).some(r => 
                        r && r.timestamp && (new Date() - new Date(r.timestamp)) < 5 * 60 * 1000
                    );
                }
            } else {
                // Fallback: verificar pelas leituras
                const latestReadings = window.latestReadings || {};
                isOnline = Object.values(latestReadings).some(r => 
                    r && r.timestamp && (new Date() - new Date(r.timestamp)) < 5 * 60 * 1000
                );
            }
            
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (statusDot && statusText) {
                statusDot.style.background = isOnline ? '#10b981' : '#ef4444';
                statusText.textContent = isOnline ? '‚óè Online' : '‚óè Offline';
            }
        }

        // Polling de dados
        async function pollData() {
            try {
                await fetchLatestReadings();
                renderDiagram();
                renderCards();
                updateStats();
                updateSystemStatus();
            } catch (error) {
                console.error('[Dashboard] Erro ao buscar dados:', error);
            }
        }

        // Inicializa√ß√£o
        async function init() {
            console.log('[Dashboard] Iniciando...');
            
            try {
                // Aguardar API Service
                let attempts = 0;
                while (!window.apiService && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.apiService) {
                    throw new Error('API Service n√£o carregou');
                }
                
                console.log('[Dashboard] API Service pronto');
                
                // Buscar dados iniciais
                await pollData();
                
                // Polling peri√≥dico
                setInterval(pollData, POLL_INTERVAL);
                
                // Listener para atualiza√ß√µes em tempo real
                window.addEventListener('readings-updated', () => {
                    renderDiagram();
                    renderCards();
                    updateStats();
                    updateSystemStatus();
                });
                
                console.log('[Dashboard] Inicializado com sucesso!');
            } catch (error) {
                console.error('[Dashboard] Erro:', error);
                document.getElementById('cardsSection').innerHTML = `
                    <div class="error-state">
                        <h2>‚ùå Erro ao carregar dados</h2>
                        <p>${error.message}</p>
                        <button onclick="window.location.reload()" 
                                style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 20px;">
                            Recarregar
                        </button>
                    </div>
                `;
            }
        }

        // Iniciar quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
