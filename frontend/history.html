<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hist√≥rico - AGUADA Dashboard</title>
    <link rel="stylesheet" href="assets/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Hist√≥rico de Leituras</h1>
            <nav>
                <a href="index.html">Dashboard</a>
                <a href="painel.html">Painel</a>
                <a href="dados.html">Dados</a>
                <a href="consumo.html">Consumo</a>
                <a href="abastecimento.html">Abastecimento</a>
                <a href="manutencao.html">Manuten√ß√£o</a>
                <a href="history.html" class="active">Hist√≥rico</a>
                <a href="alerts.html">Alertas</a>
                <a href="config.html">Config</a>
                <a href="system.html">Sistema</a>
            </nav>
            <div class="header-info">
                <div>Sistema de Monitoramento Hidr√°ulico</div>
                <div class="status-badge status-online pulsing">‚óè Online</div>
            </div>
        </header>

        <div class="card" style="margin-bottom: 30px;">
            <div class="card-header">
                <span>Filtros e Op√ß√µes</span>
            </div>
            <div class="card-body">
                <form id="filterForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <label>Sensor</label>
                        <select id="sensorFilter">
                            <option value="">Todos</option>
                            <option value="RCON">RCON</option>
                            <option value="RCAV">RCAV</option>
                            <option value="RB03">RB03</option>
                            <option value="IE01">IE01</option>
                            <option value="IE02">IE02</option>
                        </select>
                    </div>
                    <div>
                        <label>Tipo de Dado</label>
                        <select id="typeFilter">
                            <option value="distance_cm">Dist√¢ncia</option>
                            <option value="valve_in">V√°lvula Entrada</option>
                            <option value="valve_out">V√°lvula Sa√≠da</option>
                            <option value="sound_in">Fluxo de √Ågua</option>
                        </select>
                    </div>
                    <div>
                        <label>Per√≠odo</label>
                        <select id="periodFilter">
                            <option value="1d">√öltimas 24h</option>
                            <option value="7d">√öltimos 7 dias</option>
                            <option value="30d">√öltimos 30 dias</option>
                            <option value="all">Todos</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <button type="button" class="btn-primary" onclick="applyFilters()">Aplicar</button>
                        <button type="button" class="btn-secondary" onclick="exportData()" style="background: #6b7280; color: white;">Exportar</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card grid-full">
                <div class="card-header">
                    <span>Gr√°fico de Tend√™ncia</span>
                </div>
                <div class="card-body" style="text-align: center;">
                    <canvas id="trendChart" style="max-width: 100%; height: 300px;"></canvas>
                    <p style="color: #999; margin-top: 10px; font-size: 12px;">
                        üìå Gr√°fico em tempo real - atualiza a cada 30 segundos
                    </p>
                </div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 30px;">
            <div class="card-header">
                <span>Tabela de Leituras</span>
                <span id="readingCount" style="font-size: 12px;">0 registros</span>
            </div>
            <div class="card-body">
                <table id="readingsTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Sensor</th>
                            <th>Tipo</th>
                            <th>Valor</th>
                            <th>Unidade</th>
                            <th>Bateria</th>
                            <th>RSSI</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" style="text-align: center; color: #999;">‚è≥ Carregando dados...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="stats-footer">
            <div class="stat">
                <div class="stat-value" id="maxValue">0</div>
                <div class="stat-label">M√°ximo</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="minValue">0</div>
                <div class="stat-label">M√≠nimo</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="avgValue">0</div>
                <div class="stat-label">M√©dia</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stdValue">0</div>
                <div class="stat-label">Desvio Padr√£o</div>
            </div>
        </div>
    </div>

    <script src="assets/app.js"></script>
    <script>
        // Load history data
        let historyData = {};
        let filteredData = [];

        function initHistory() {
            // Generate demo data for each sensor
            Object.keys(SENSORS).forEach(sensorId => {
                historyData[sensorId] = generateHistoryData(sensorId, 7);
            });

            loadReadings();
            updateStats();
            renderChart();
        }

        function loadReadings() {
            const tbody = document.querySelector('#readingsTable tbody');
            tbody.innerHTML = '';

            let sensor = document.getElementById('sensorFilter').value;
            let type = document.getElementById('typeFilter').value;
            let period = document.getElementById('periodFilter').value;

            // Filter data
            filteredData = [];
            Object.entries(historyData).forEach(([sId, readings]) => {
                if (sensor && sId !== sensor) return;

                readings.forEach(reading => {
                    if (period === '1d') {
                        const oneDay = new Date(Date.now() - 24 * 60 * 60 * 1000);
                        if (new Date(reading.timestamp) < oneDay) return;
                    }

                    filteredData.push({
                        sensor: sId,
                        ...reading
                    });
                });
            });

            // Render rows
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">Nenhum dado encontrado</td></tr>';
            } else {
                filteredData.forEach(reading => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDateTime(reading.timestamp)}</td>
                        <td><strong>${reading.sensor}</strong></td>
                        <td>${type === 'distance_cm' ? 'Dist√¢ncia' : 
                              type === 'valve_in' ? 'V√°lvula Entrada' :
                              type === 'valve_out' ? 'V√°lvula Sa√≠da' : 'Fluxo'}</td>
                        <td>${type === 'distance_cm' ? (reading.distance_cm / 100).toFixed(2) : reading[type]}</td>
                        <td>${type === 'distance_cm' ? 'cm' : type.includes('valve') ? '0/1' : 'bool'}</td>
                        <td>${reading.battery ? reading.battery + ' mV' : '-'}</td>
                        <td>${reading.rssi ? reading.rssi + ' dBm' : '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            document.getElementById('readingCount').textContent = filteredData.length + ' registros';
        }

        function applyFilters() {
            loadReadings();
            renderChart();
            updateStats();
        }

        function exportData() {
            if (filteredData.length === 0) {
                alert('Nenhum dado para exportar');
                return;
            }

            const csvData = filteredData.map(r => ({
                'Data/Hora': formatDateTime(r.timestamp),
                'Sensor': r.sensor,
                'Valor': r.distance_cm || r.valve_in || r.valve_out || r.sound_in,
                'Bateria': r.battery || '',
                'RSSI': r.rssi || ''
            }));

            exportToCSV(csvData, 'aguada-historico.csv');
        }

        function updateStats() {
            const values = filteredData
                .filter(d => d.distance_cm)
                .map(d => d.distance_cm / 100);

            if (values.length === 0) {
                document.getElementById('maxValue').textContent = '0';
                document.getElementById('minValue').textContent = '0';
                document.getElementById('avgValue').textContent = '0';
                document.getElementById('stdValue').textContent = '0';
                return;
            }

            const max = Math.max(...values);
            const min = Math.min(...values);
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            const std = Math.sqrt(values.reduce((sq, n) => sq + Math.pow(n - avg, 2), 0) / values.length);

            document.getElementById('maxValue').textContent = max.toFixed(2);
            document.getElementById('minValue').textContent = min.toFixed(2);
            document.getElementById('avgValue').textContent = avg.toFixed(2);
            document.getElementById('stdValue').textContent = std.toFixed(2);
        }

        function renderChart() {
            const canvas = document.getElementById('trendChart');
            if (!canvas) return;

            // Simple text chart (use Chart.js for real implementation)
            const ctx = canvas.getContext ? canvas.getContext('2d') : null;
            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#667eea';
                ctx.fillRect(10, 50, canvas.width - 20, 100);
            }

            // TODO: Integrate Chart.js library for real graphs
            canvas.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">üìà Gr√°fico (requer Chart.js)</div>';
        }

        // Initialize
        initHistory();
    </script>
</body>
</html>
