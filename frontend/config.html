<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes - AGUADA Dashboard</title>
    <link rel="stylesheet" href="assets/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öôÔ∏è Configura√ß√µes do Sistema</h1>
            <nav>
                <a href="index.html">Dashboard</a>
                <a href="painel.html">Painel</a>
                <a href="dados.html">Dados</a>
                <a href="consumo.html">Consumo</a>
                <a href="abastecimento.html">Abastecimento</a>
                <a href="manutencao.html">Manuten√ß√£o</a>
                <a href="history.html">Hist√≥rico</a>
                <a href="alerts.html">Alertas</a>
                <a href="config.html" class="active">Config</a>
                <a href="system.html">Sistema</a>
            </nav>
            <div class="header-info">
                <div>Sistema de Monitoramento Hidr√°ulico</div>
                <div class="status-badge status-online pulsing">‚óè Online</div>
            </div>
        </header>

        <div class="card" style="margin-bottom: 30px;">
            <div class="card-header">
                <span>Limites e Thresholds</span>
            </div>
            <div class="card-body">
                <form>
                    <div class="grid-2col">
                        <div>
                            <label for="minLevel">N√≠vel M√≠nimo de Alerta (%)</label>
                            <input type="number" id="minLevel" value="20" min="0" max="100">
                        </div>
                        <div>
                            <label for="maxLevel">N√≠vel M√°ximo de Alerta (%)</label>
                            <input type="number" id="maxLevel" value="95" min="0" max="100">
                        </div>
                        <div>
                            <label for="consumoAlerta">Taxa de Consumo Cr√≠tica (cm/min)</label>
                            <input type="number" id="consumoAlerta" value="5.0" step="0.1" min="0">
                        </div>
                        <div>
                            <label for="valveTimeout">Timeout de V√°lvula (segundos)</label>
                            <input type="number" id="valveTimeout" value="300" min="10">
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <h3 style="margin-bottom: 15px; color: #1e3c72;">Configura√ß√£o por Sensor</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div style="border: 1px solid #e5e7eb; padding: 15px; border-radius: 6px;">
                                <h4 style="margin-bottom: 10px;">RCON</h4>
                                <label>Altura do Reservat√≥rio (cm)</label>
                                <input type="number" value="40000" min="0">
                                <label style="margin-top: 10px;">N√≠vel Ideal (%)</label>
                                <input type="number" value="75" min="0" max="100">
                            </div>

                            <div style="border: 1px solid #e5e7eb; padding: 15px; border-radius: 6px;">
                                <h4 style="margin-bottom: 10px;">RCAV</h4>
                                <label>Altura do Reservat√≥rio (cm)</label>
                                <input type="number" value="35000" min="0">
                                <label style="margin-top: 10px;">N√≠vel Ideal (%)</label>
                                <input type="number" value="70" min="0" max="100">
                            </div>

                            <div style="border: 1px solid #e5e7eb; padding: 15px; border-radius: 6px;">
                                <h4 style="margin-bottom: 10px;">RB03</h4>
                                <label>Altura do Reservat√≥rio (cm)</label>
                                <input type="number" value="30000" min="0">
                                <label style="margin-top: 10px;">N√≠vel Ideal (%)</label>
                                <input type="number" value="65" min="0" max="100">
                            </div>

                            <div style="border: 1px solid #e5e7eb; padding: 15px; border-radius: 6px;">
                                <h4 style="margin-bottom: 10px;">IE01</h4>
                                <label>Altura do Reservat√≥rio (cm)</label>
                                <input type="number" value="25000" min="0">
                                <label style="margin-top: 10px;">N√≠vel Ideal (%)</label>
                                <input type="number" value="60" min="0" max="100">
                            </div>

                            <div style="border: 1px solid #e5e7eb; padding: 15px; border-radius: 6px;">
                                <h4 style="margin-bottom: 10px;">IE02</h4>
                                <label>Altura do Reservat√≥rio (cm)</label>
                                <input type="number" value="25000" min="0">
                                <label style="margin-top: 10px;">N√≠vel Ideal (%)</label>
                                <input type="number" value="60" min="0" max="100">
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button type="button" class="btn-success">üíæ Salvar Configura√ß√µes</button>
                        <button type="button" class="btn-secondary" onclick="resetConfig()" style="background: #6b7280; color: white; border: none;">üîÑ Restaurar Padr√£o</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">
                    <span>Calibra√ß√£o de Sensores</span>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 15px;">
                        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                            Selecione um sensor para iniciar a calibra√ß√£o. O processo leva aproximadamente 2 minutos.
                        </p>
                    </div>

                    <div style="display: grid; gap: 10px;">
                        <button onclick="calibrateSensor('RCON')" class="btn-primary" style="font-size: 12px;">üìä Calibrar RCON</button>
                        <button onclick="calibrateSensor('RCAV')" class="btn-primary" style="font-size: 12px;">üìä Calibrar RCAV</button>
                        <button onclick="calibrateSensor('RB03')" class="btn-primary" style="font-size: 12px;">üìä Calibrar RB03</button>
                        <button onclick="calibrateSensor('IE01')" class="btn-primary" style="font-size: 12px;">üìä Calibrar IE01</button>
                        <button onclick="calibrateSensor('IE02')" class="btn-primary" style="font-size: 12px;">üìä Calibrar IE02</button>
                    </div>

                    <div id="calibrationStatus" style="background: #f0fdf4; padding: 10px; border-radius: 5px; margin-top: 15px; border-left: 3px solid #10b981;">
                        <p style="font-size: 11px; color: #999; text-align: center;">
                            ‚è≥ Carregando status de calibra√ß√£o...
                        </p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>Sincroniza√ß√£o de Hora</span>
                </div>
                <div class="card-body">
                    <div class="data-row">
                        <div class="data-item">
                            <div class="data-label">Hora do Sistema</div>
                            <div class="data-value" style="font-size: 16px;" id="systemTime">14:32:45</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Hora do Gateway</div>
                            <div class="data-value" style="font-size: 16px;">14:32:44</div>
                        </div>
                    </div>

                    <div style="margin: 15px 0;">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: normal; cursor: pointer;">
                            <input type="checkbox" checked>
                            <span>Sincronizar automaticamente (NTP)</span>
                        </label>
                    </div>

                    <button class="btn-primary" style="font-size: 12px; width: 100%;">üîÑ Sincronizar Agora</button>
                </div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 30px;">
            <div class="card-header">
                <span>Backup e Restaura√ß√£o</span>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div>
                        <h4 style="margin-bottom: 10px;">Backup de Dados</h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                            Fa√ßa backup de todos os dados do sistema para proteger contra perda de dados.
                        </p>
                        <button class="btn-primary" style="font-size: 12px; width: 100%;">üíæ Fazer Backup Agora</button>
                        <p style="font-size: 11px; color: #999; margin-top: 10px;">
                            √öltimo backup: 2024-11-16 03:45:00 (2.1 GB)
                        </p>
                    </div>

                    <div>
                        <h4 style="margin-bottom: 10px;">Hist√≥rico de Backups</h4>
                        <select style="width: 100%; margin-bottom: 10px;">
                            <option>Selecione um backup...</option>
                            <option>2024-11-16 03:45:00 (2.1 GB)</option>
                            <option>2024-11-15 03:45:00 (2.0 GB)</option>
                            <option>2024-11-14 03:45:00 (1.9 GB)</option>
                        </select>
                        <button class="btn-warning" style="font-size: 12px; width: 100%; background: #f59e0b; color: white; border: none;">‚Üì Download</button>
                    </div>

                    <div>
                        <h4 style="margin-bottom: 10px;">Restaurar Dados</h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                            Restaure dados de um backup anterior (requer reinicializa√ß√£o).
                        </p>
                        <input type="file" accept=".sql" style="margin-bottom: 10px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 5px; width: 100%; font-size: 12px;">
                        <button class="btn-danger" style="font-size: 12px; width: 100%;">‚ö†Ô∏è Restaurar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 30px;">
            <div class="card-header">
                <span>Sobre o Sistema</span>
            </div>
            <div class="card-body">
                <div class="data-row">
                    <div class="data-item">
                        <div class="data-label">Vers√£o AGUADA</div>
                        <div class="data-value" style="font-size: 16px;">1.0.0</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Build Date</div>
                        <div class="data-value" style="font-size: 14px;">2024-11-01</div>
                    </div>
                </div>

                <div class="data-row">
                    <div class="data-item">
                        <div class="data-label">Vers√£o ESP-IDF</div>
                        <div class="data-value" style="font-size: 16px;">6.1.0</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Vers√£o Node.js</div>
                        <div class="data-value" style="font-size: 16px;">20.x</div>
                    </div>
                </div>

                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <h4 style="margin-bottom: 10px;">Componentes</h4>
                    <ul style="font-size: 12px; color: #666; line-height: 1.8;">
                        <li>‚úÖ ESP32-C3 SuperMini x5 (sensores)</li>
                        <li>‚úÖ AJ-SR04M Ultrasonic Sensor x5</li>
                        <li>‚úÖ PostgreSQL + TimescaleDB</li>
                        <li>‚úÖ Node.js Express Backend</li>
                        <li>‚úÖ Grafana Dashboard</li>
                        <li>‚úÖ MQTT Broker</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="stats-footer">
            <div class="stat">
                <div class="stat-value">5/5</div>
                <div class="stat-label">Sensores</div>
            </div>
            <div class="stat">
                <div class="stat-value">‚úÖ</div>
                <div class="stat-label">Sistema OK</div>
            </div>
            <div class="stat">
                <div class="stat-value">45d</div>
                <div class="stat-label">Uptime</div>
            </div>
            <div class="stat">
                <div class="stat-value">v1.0.0</div>
                <div class="stat-label">Vers√£o</div>
            </div>
        </div>
    </div>

    <script src="assets/api-service.js"></script>
    <script src="assets/ui-utils.js"></script>
    <script src="assets/app.js"></script>
    <script>
        // Update system time
        function updateSystemTime() {
            const systemTimeEl = document.getElementById('systemTime');
            if (systemTimeEl) {
                if (typeof formatTime === 'function') {
                    systemTimeEl.textContent = formatTime(new Date());
                } else {
                    systemTimeEl.textContent = new Date().toLocaleTimeString('pt-BR');
                }
            }
        }
        setInterval(updateSystemTime, 1000);

        // Carregar status de calibra√ß√£o
        async function loadCalibrationStatus() {
            try {
                if (!window.apiService) {
                    console.warn('[Config] API Service n√£o dispon√≠vel');
                    return;
                }
                
                // Buscar status dos sensores
                const sensorsStatus = await window.apiService.getSensorsStatus();
                const calibrationStatusEl = document.getElementById('calibrationStatus');
                
                if (!calibrationStatusEl) return;
                
                if (!sensorsStatus || sensorsStatus.length === 0) {
                    calibrationStatusEl.innerHTML = '<p style="font-size: 11px; color: #999;">Nenhum sensor encontrado</p>';
                    return;
                }
                
                // Gerar status de calibra√ß√£o (simplificado - n√£o temos endpoint espec√≠fico)
                const statusItems = sensorsStatus.slice(0, 5).map(sensor => {
                    const elementoId = sensor.elemento_id || sensor.sensor_id;
                    const isOnline = sensor.estado_conexao === 'online';
                    const statusIcon = isOnline ? '‚úÖ' : '‚ö†Ô∏è';
                    const statusText = isOnline ? 'OK' : 'Verificar';
                    
                    return `<p style="font-size: 11px; color: #065f46; margin-top: 3px;">
                        ${statusIcon} ${elementoId}: ${statusText}
                    </p>`;
                }).join('');
                
                calibrationStatusEl.innerHTML = statusItems || '<p style="font-size: 11px; color: #999;">Nenhum status dispon√≠vel</p>';
                
            } catch (error) {
                console.error('[Config] Erro ao carregar status de calibra√ß√£o:', error);
            }
        }

        // Carregar configura√ß√µes dos sensores
        async function loadSensorConfigs() {
            try {
                if (!window.apiService) return;
                
                // Buscar todos os sensores
                const baseURL = window.apiService.baseURL || 'http://localhost:3000/api';
                const response = await fetch(`${baseURL}/sensors`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    // Atualizar campos de configura√ß√£o se necess√°rio
                    // Por enquanto, apenas logamos os dados
                    console.log('[Config] Sensores carregados:', result.data);
                }
            } catch (error) {
                console.error('[Config] Erro ao carregar configura√ß√µes:', error);
            }
        }

        function calibrateSensor(sensorId) {
            if (!window.apiService) {
                alert('API Service n√£o dispon√≠vel');
                return;
            }
            
            if (confirm(`Iniciar calibra√ß√£o de ${sensorId}?\n\nEste processo leva aproximadamente 2 minutos.\nN√£o desligue o dispositivo durante a calibra√ß√£o.`)) {
                // Chamar API de calibra√ß√£o
                const baseURL = window.apiService.baseURL || 'http://localhost:3000/api';
                fetch(`${baseURL}/calibration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sensor_id: window.SENSORS?.[sensorId]?.sensor_id || sensorId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Calibra√ß√£o de ${sensorId} iniciada com sucesso!`);
                        loadCalibrationStatus();
                    } else {
                        alert(`Erro ao iniciar calibra√ß√£o: ${data.error || 'Erro desconhecido'}`);
                    }
                })
                .catch(error => {
                    console.error('[Config] Erro ao calibrar sensor:', error);
                    alert(`Erro ao iniciar calibra√ß√£o: ${error.message}`);
                });
            }
        }

        function resetConfig() {
            if (confirm('Tem certeza? Isso restaurar√° todas as configura√ß√µes aos valores padr√£o.')) {
                // TODO: Implementar reset via API
                alert('Configura√ß√µes restauradas!');
                location.reload();
            }
        }

        // Inicializar
        async function init() {
            console.log('[Config] Inicializando p√°gina...');
            
            // Aguardar API Service
            let attempts = 0;
            while (!window.apiService && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (window.apiService) {
                await loadCalibrationStatus();
                await loadSensorConfigs();
            }
            
            console.log('[Config] P√°gina inicializada');
        }
        
        // Iniciar quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
